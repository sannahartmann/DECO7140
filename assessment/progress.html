<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/css_reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <title>InShape: Progress</title>
    <script type="module">
      import { logPageLoadmessage, uploadProgress, fetchProgress } from './js/components.js';

      document.addEventListener('DOMContentLoaded', () => {
        logPageLoadmessage();
        fetchProgress(displayProgress, handleGETError);

        const form = document.getElementById('progressForm');
        form.addEventListener('submit', handleSubmit);
      });

      function handleSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        // Add required fields for the API
        formData.append('product_name', 'Progress Entry');
        formData.append('product_owner', 'User');
        formData.append('product_description', `Exercise: ${formData.get('exercise')}, Duration: ${formData.get('duration')} minutes, Weight: ${formData.get('weight')} kg`);
        
        uploadProgress(formData, handleSuccess, handleError);
      }

      function handleSuccess(result) {
        console.log('Progress uploaded', result);
        alert('Progress uploaded successfully!');
        fetchProgress(displayProgress, handleGETError);
        document.getElementById('progressForm').reset();
      }

      function handleError(error) {
        console.error('Error uploading progress:', error);
        alert('Error uploading progress: ' + error.message);
      }

      function handleGETError(error) {
        console.error('Error fetching progress:', error);
        alert('Error fetching progress data. Please try again later.');
      }

      function displayProgress(data) {
        const tableBody = document.querySelector('#progressTable tbody');
        tableBody.innerHTML = '';
        data.forEach(item => {
          const row = tableBody.insertRow();
          const date = item.created_at ? new Date(item.created_at).toLocaleDateString() : 'N/A';
          row.insertCell(0).textContent = date;

          let exercise = 'N/A';
          let duration = 'N/A';
          let weight = 'N/A';

          if (item.product_description) {
            const parts = item.product_description.split(', ');
            parts.forEach(part => {
              if (part.startsWith('Exercise:')) {
                exercise = part.split(': ')[1];
              } else if (part.startsWith('Duration:')) {
                duration = part.split(': ')[1];
              } else if (part.startsWith('Weight:')) {
                weight = part.split(': ')[1];
              }
            });
          }

          row.insertCell(1).textContent = weight;
          row.insertCell(2).textContent = exercise;
          row.insertCell(3).textContent = duration;
        });
      }
    </script>
  </head>
  <body>
    <header>
      <div class="project-box-head">
        <img src="images/logo.png" alt="logo" class="logo"/>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="workouts.html">Workouts</a>
        <a href="nutrition.html">Nutrition</a>
        <a href="forum.html">Forum</a>
      </nav>
    </header>
    <main class="page-container">
      <h1>Track Your Progress</h1>
      <p>Log your fitness journey:</p>
      <form id="progressForm" class="progress-form">
        <div class="form-group">
          <label for="exercise">Exercise Completed:</label>
          <input type="text" id="exercise" name="exercise" maxlength="100" required>
        </div>
        <div class="form-group">
          <label for="duration">Duration (minutes):</label>
          <input type="number" id="duration" name="duration" min="1" max="1440" required>
        </div>
        <div class="form-group">
          <label for="weight">Weight (kg):</label>
          <input type="number" id="weight" name="weight" step="0.1" min="20" max="300" required>
        </div>
        <button type="submit" class="btn-action">Log Progress</button>
      </form>

      <h2>Progress Log</h2>
      <table id="progressTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Weight (kg)</th>
            <th>Exercise</th>
            <th>Duration (min)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Progress data will be inserted here by JavaScript -->
        </tbody>
      </table>
    </main>
    <footer>
      <p>&copy; 2024 InShape. All rights reserved.</p>
    </footer>
  </body>
</html>